# 点菜页面性能优化文档

## 背景

点菜页面面临 3000+ 道带图片菜品的渲染挑战，React Native 原生 `ScrollView` 会一次性渲染所有项目，导致：
- 内存占用过高
- 滚动卡顿、掉帧
- 出现白屏现象

## 优化方案

### 1. 使用 FlashList 替代 ScrollView

**核心库**: `@shopify/flash-list`

**原理**: Cell Recycling（组件实例回收），不销毁超出屏幕的组件，而是回收再利用。

**优势**:
- 性能提升 5-10 倍
- 内存占用大幅降低
- 滚动流畅无白屏

### 2. 使用 FastImage 替代 Image

**核心库**: `react-native-fast-image`

**功能**:
- 智能磁盘缓存（App 重启后仍从本地读取）
- 优先级加载（可视区域优先）
- 预加载支持

### 3. React.memo 避免重渲染

商品卡片使用 `React.memo` 包装，确保只有 `id`、`quantity` 或 `price` 变化时才重渲染。

## 文件结构

```
src/
├── components/
│   └── ProductCard.tsx    # 商品卡片组件（已优化）
└── screens/
    └── OrderScreen.tsx    # 点菜页面（已优化）
```

## 核心代码

### FlashList 配置

```typescript
<FlashList
  data={products}
  renderItem={({ item, index }) => (
    <ProductCard
      product={item}
      numColumns={numColumns}
      onQuantityChange={updateProductQuantity}
      index={index}
    />
  )}
  keyExtractor={item => item.id}
  estimatedItemSize={200}
  numColumns={numColumns}
  windowSize={7}
  maxToRenderPerBatch={10}
  initialNumToRender={12}
  removeClippedSubviews
/>
```

### 优化参数说明

| 参数 | 值 | 说明 |
|------|-----|------|
| `windowSize` | 7 | 减少同时渲染的内容，降低内存占用 |
| `maxToRenderPerBatch` | 10 | 每帧渲染数量，平衡性能与流畅度 |
| `initialNumToRender` | 12 | 首屏快速渲染的项目数 |
| `removeClippedSubviews` | true | 视口外组件不活跃 |
| `estimatedItemSize` | 200 | 估算项目高度，优化滚动计算 |

### 动态列数

```typescript
const numColumns = useMemo(() => {
  return SCREEN_WIDTH >= 1200 ? 4 : 3;
}, []);
```

- 大屏 iPad（≥1200px）：4 列
- 小屏 iPad：3 列

## 安装依赖

### 版本要求

| 依赖库 | 当前使用版本 | React Native 最低版本要求 | React 最低版本要求 |
|--------|-------------|-------------------------|-------------------|
| `@shopify/flash-list` | ^2.2.0 | 无限制（*） | 无限制（*） |
| `react-native-fast-image` | ^8.6.3 | >= 0.60.0 | ^17 \|\| ^18 |

> 数据来源：查看各库 GitHub 仓库的 `package.json` peerDependencies

### 安装命令

```bash
npm install @shopify/flash-list@^2.2.0 react-native-fast-image@^8.6.3 --legacy-peer-deps

# iOS 需要执行
cd ios && pod install
```

## 优化效果预估

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 3000 道菜渲染时间 | 5-10 秒 | <1 秒 |
| 内存占用 | 极高 | 降低 60-70% |
| 滚动帧率 | 30-40 FPS | 60 FPS 稳定 |
| 白屏现象 | 频繁 | 无 |

## 注意事项

1. **iOS Pod 依赖**: 安装完成后必须执行 `pod install`
2. **React 19 兼容性**: 使用 `--legacy-peer-deps` 解决 FastImage 依赖冲突
3. **图片尺寸**: 建议后端提供缩略图 URL，减少解压内存占用
4. **分类数据**: 真实场景中应按分类切片数据，避免一次性加载 3000 条
